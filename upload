#!/usr/bin/env bash

# ATTENTION:
# Before calling this script, the Arduino needs to be erased. Until we figure
# out how to do that automatically, doing it manually is a feasible workaround.
# Just make sure to press the tiny "ERASE" button on the Arduino Due before
# uploading and everything should work.

mkdir -p output

rustc \
	--target=target.json \
	-o output/libcore.rlib \
	vendor/rust/src/libcore/lib.rs &&

rustc \
	--target=target.json \
	-C link-args="-Tlinker-script.ld" \
	-L output \
	-o output/blink.elf \
	blink/blink.rs &&

arm-none-eabi-objcopy \
	-O binary \
	output/blink.elf \
	output/blink.bin &&

bossac --write --verify --boot -R output/blink.bin
