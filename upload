#!/usr/bin/env bash

# ATTENTION:
# Before calling this script, the Arduino needs to be erased. Until we figure
# out how to do that automatically, doing it manually is a feasible workaround.
# Just make sure to press the tiny "Erase" button on the Arduino Due before
# uploading and everything should work.

arm-none-eabi-gcc \
	-c \
	-nostdlib \
	-mcpu=cortex-m3 \
	-mthumb \
	blink.c \
	-o blink.o &&

arm-none-eabi-gcc \
	-Wl,--gc-sections \
	-mcpu=cortex-m3 \
	-Tlinker-script.ld \
	-mthumb \
	-Wl,--entry=Reset_Handler \
	blink.o \
	libsam_sam3x8e_gcc_rel.a \
	-o blink.elf &&

arm-none-eabi-objcopy \
	-O binary \
	blink.elf \
	blink.bin &&

bossac --write --verify --boot -R blink.bin
