#!/usr/bin/env bash

# ATTENTION:
# Before calling this script, the Arduino needs to be erased. Until we figure
# out how to do that automatically, doing it manually is a feasible workaround.
# Just make sure to press the tiny "Erase" button on the Arduino Due before
# uploading and everything should work.

# ATTENTION 2:
# This build script requires an installation of the Arduino IDE. Please make
# sure you have a recent version installed and add its path to the ARDUINO_IDE
# variable below.

# The following variables need to be modified for your system before the build
# can work.

# Installation directory of the Arduino IDE
ARDUINO_IDE=/home/hanno/Downloads/arduino-1.7.0-linux64

# From here on out, the script *should* work without system-specific
# modifications.

arm-none-eabi-g++ \
	-c \
	-nostdlib \
	-mcpu=cortex-m3 \
	-mthumb \
	blink.c \
	-o blink.o &&

arm-none-eabi-gcc \
	-c \
	-w \
	-nostdlib \
	-Dprintf=iprintf \
	-MMD \
	-mcpu=cortex-m3 \
	-DF_CPU=84000000L \
	-DARDUINO=10700 \
	-DARDUINO_SAM_DUE \
	-DARDUINO_ARCH_SAM \
	-D__SAM3X8E__ \
	-mthumb \
	-DUSB_VID=0x2a03 \
	-DUSB_PID=0x003e \
	-DUSBCON \
	-DUSB_MANUFACTURER="Unknown" \
	-DUSB_PRODUCT="\"Arduino Due\"" \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/libsam \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/CMSIS/CMSIS/Include/ \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/CMSIS/Device/ATMEL/ \
	-I$ARDUINO_IDE/hardware/arduino/sam/cores/arduino \
	-I$ARDUINO_IDE/hardware/arduino/sam/variants/arduino_due_x \
	$ARDUINO_IDE/hardware/arduino/sam/cores/arduino/hooks.c \
	-o hooks.c.o &&
arm-none-eabi-gcc \
	-c \
	-w \
	-nostdlib \
	-Dprintf=iprintf \
	-MMD \
	-mcpu=cortex-m3 \
	-DF_CPU=84000000L \
	-DARDUINO=10700 \
	-DARDUINO_SAM_DUE \
	-DARDUINO_ARCH_SAM \
	-D__SAM3X8E__ \
	-mthumb \
	-DUSB_VID=0x2a03 \
	-DUSB_PID=0x003e \
	-DUSBCON \
	-DUSB_MANUFACTURER="Unknown" \
	-DUSB_PRODUCT="\"Arduino Due\"" \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/libsam \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/CMSIS/CMSIS/Include/ \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/CMSIS/Device/ATMEL/ \
	-I$ARDUINO_IDE/hardware/arduino/sam/cores/arduino \
	-I$ARDUINO_IDE/hardware/arduino/sam/variants/arduino_due_x \
	$ARDUINO_IDE/hardware/arduino/sam/cores/arduino/cortex_handlers.c \
	-o cortex_handlers.c.o &&
arm-none-eabi-g++ \
	-c \
	-w \
	-nostdlib \
	-Dprintf=iprintf \
	-MMD \
	-mcpu=cortex-m3 \
	-DF_CPU=84000000L \
	-DARDUINO=10700 \
	-DARDUINO_SAM_DUE \
	-DARDUINO_ARCH_SAM \
	-D__SAM3X8E__ \
	-mthumb \
	-DUSB_VID=0x2a03 \
	-DUSB_PID=0x003e \
	-DUSBCON \
	-DUSB_MANUFACTURER="Unknown" \
	-DUSB_PRODUCT="\"Arduino Due\"" \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/libsam \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/CMSIS/CMSIS/Include/ \
	-I$ARDUINO_IDE/hardware/arduino/sam/system/CMSIS/Device/ATMEL/ \
	-I$ARDUINO_IDE/hardware/arduino/sam/cores/arduino \
	-I$ARDUINO_IDE/hardware/arduino/sam/variants/arduino_due_x \
	$ARDUINO_IDE/hardware/arduino/sam/cores/arduino/Reset.cpp \
	-o Reset.cpp.o &&

rm -f core.a &&
arm-none-eabi-ar rcs core.a hooks.c.o &&
arm-none-eabi-ar rcs core.a cortex_handlers.c.o &&
arm-none-eabi-ar rcs core.a Reset.cpp.o &&

arm-none-eabi-gcc \
	-Wl,--gc-sections \
	-mcpu=cortex-m3 \
	-T$ARDUINO_IDE/hardware/arduino/sam/variants/arduino_due_x/linker_scripts/gcc/flash.ld \
	-L. \
	-mthumb \
	-Wl,--entry=Reset_Handler \
	-Wl,--start-group \
		blink.o \
		$ARDUINO_IDE/hardware/arduino/sam/variants/arduino_due_x/libsam_sam3x8e_gcc_rel.a \
		core.a \
	-Wl,--end-group \
	-lm \
	-o blink.elf &&

arm-none-eabi-objcopy \
	-O binary \
	blink.elf \
	blink.bin &&

bossac --write --verify --boot -R blink.bin
